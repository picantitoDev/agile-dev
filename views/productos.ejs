<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Lista de Productos</title>
    <link rel="stylesheet" href="/listarProductos.css" />
    <style>
      /* Estilos del toggle switch */
      .status-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: 1rem;
      }

      #statusLabel {
        display: inline-block;
        width: 60px;
        text-align: left;
        margin-right: 0.5rem;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      .switch input:checked + .slider {
        background-color: #4caf50;
      }

      .switch input:checked + .slider:before {
        transform: translateX(26px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="top-bar">
        <a href="/" class="back-btn">Atrás</a>
      </header>

      <section class="filtering">
        <div class="search">
          <input
            type="text"
            id="searchBar"
            class="search-input"
            placeholder="Buscar producto..."
          />
        </div>
        <div class="filter">
          <div class="status-toggle">
            <label class="switch">
              <input type="checkbox" id="statusToggle" checked />
              <span class="slider"></span>
            </label>
            <span id="statusLabel">Activos</span>
          </div>

          <select id="categoryFilter" class="category-select">
            <option value="all">Todas las categorías</option>
            <option value="Abarrotes">Abarrotes</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Limpieza">Limpieza</option>
            <option value="Enlatados">Enlatados</option>
            <option value="Higiene Personal">Higiene Personal</option>
            <option value="Papelería">Papelería</option>
            <option value="Ferretería">Ferretería</option>
            <option value="Congelados">Congelados</option>
            <option value="Snacks">Snacks</option>
            <option value="Productos Frescos">Productos Frescos</option>
          </select>

          <form
            action="/productos/crear-producto"
            method="GET"
            class="add-form"
          >
            <button type="submit" class="add-btn">+</button>
          </form>
        </div>
      </section>

      <div class="table-container">
        <table class="product-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Stock</th>
              <th>Precio Unitario</th>
              <th>Categoría</th>
              <th>Unidad de Medida</th>
              <th>Detalle</th>
            </tr>
          </thead>
          <tbody id="productTableBody">
            <% productos.forEach((producto) => { %>
            <tr>
              <td><%= producto.nombre %></td>
              <td><%= producto.stock %></td>
              <td>S/. <%= producto.precio_unitario %></td>
              <td><%= producto.categoria %></td>
              <td><%= producto.unidad_medida %></td>
              <td>
                <a
                  class="view-btn"
                  href="/productos/detalle/<%= producto.id %>"
                >
                  Ver Detalle
                </a>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <script id="productos-data" type="application/json">
      <%- JSON.stringify(productos) %>
    </script>

    <script>
      const searchBar = document.getElementById("searchBar")
      const categoryFilter = document.getElementById("categoryFilter")
      const statusToggle = document.getElementById("statusToggle")
      const statusLabel = document.getElementById("statusLabel")
      const productTableBody = document.getElementById("productTableBody")

      const productos = JSON.parse(
        document.getElementById("productos-data").textContent
      )

      function renderTable(filteredProductos) {
        productTableBody.innerHTML = ""
        filteredProductos.forEach((producto) => {
          const row = document.createElement("tr")
          row.innerHTML = `
            <td>${producto.nombre}</td>
            <td>${producto.stock}</td>
            <td>S/. ${producto.precio_unitario}</td>
            <td>${producto.categoria}</td>
            <td>${producto.unidad_medida}</td>
            <td><a class="view-btn" href="/productos/detalle/${producto.id}">Ver Detalle</a></td>
          `
          productTableBody.appendChild(row)
        })
      }

      function filterProducts() {
        const searchText = searchBar.value.toLowerCase().trim()
        const selectedCategory = categoryFilter.value
        const selectedStatus = statusToggle.checked ? "Activado" : "Desactivado"

        statusLabel.textContent = statusToggle.checked ? "Activos" : "Inactivos"

        const filteredProductos = productos.filter((producto) => {
          const matchesSearch = producto.nombre
            .toLowerCase()
            .includes(searchText)
          const matchesCategory =
            selectedCategory === "all" ||
            producto.categoria === selectedCategory
          const matchesStatus = producto.estado === selectedStatus
          return matchesSearch && matchesCategory && matchesStatus
        })

        renderTable(filteredProductos)
      }

      // Event listeners
      searchBar.addEventListener("input", filterProducts)
      categoryFilter.addEventListener("change", filterProducts)
      statusToggle.addEventListener("change", filterProducts)

      // Cargar solo los productos activos por defecto
      renderTable(productos.filter((p) => p.estado === "Activado"))
    </script>
  </body>
</html>
