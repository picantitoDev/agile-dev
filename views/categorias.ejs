<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Categorías</title>
    <link rel="stylesheet" href="/listarCategorias.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <a href="/">← Atrás</a>

      <h1>Listado de Categorías</h1>

      <!-- Formulario para crear nueva categoría -->
      <form action="/categorias" method="POST" class="categoria-form">
        <label for="nombre">Nueva Categoría:</label>
        <input type="text" id="nombre" name="nombre" required />
        <button type="submit" class="btn-agregar">Agregar</button>
      </form>

      <!-- Tabla de categorías existentes -->
      <table class="categoria-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% categorias.forEach((cat) => { %>
          <tr>
            <td><%= cat.id %></td>
            <td><%= cat.nombre %></td>
            <td class="acciones">
              <button class="btn-editar" data-id="<%= cat.id %>" data-nombre="<%= cat.nombre %>">
                <i class="fas fa-pencil-alt"></i>
              </button>
              <button class="btn-eliminar" data-id="<%= cat.id %>" data-nombre="<%= cat.nombre %>">
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>

      <div id="modalEditar" class="modal-overlay">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">Editar Categoría</h3>
            <button class="btn-cerrar">&times;</button>
          </div>
          <form class="modal-form" id="formEditar">
            <input type="hidden" id="editId" name="id">
            <div class="form-group">
              <label for="editNombre">Nombre:</label>
              <input type="text" id="editNombre" name="nombre" required>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn-cancelar">Cancelar</button>
              <button type="submit" class="btn-guardar">Guardar cambios</button>
            </div>
          </form>
        </div>
      </div>
  
      <div id="modalEliminar" class="modal-overlay">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">Confirmar eliminación</h3>
            <button class="btn-cerrar">&times;</button>
          </div>
          <p>¿Estás seguro de que deseas eliminar la categoría "<span id="nombreCategoria"></span>"?</p>
          <form class="modal-form" id="formEliminar">
            <input type="hidden" id="eliminarId" name="id">
            <div class="modal-footer">
              <button type="button" class="btn-cancelar">Cancelar</button>
              <button type="submit" class="btn-confirmar-eliminar">Eliminar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const modalEditar = document.getElementById('modalEditar');
        const modalEliminar = document.getElementById('modalEliminar');
        const formEditar = document.getElementById('formEditar');
        const formEliminar = document.getElementById('formEliminar');
        const btnsEditar = document.querySelectorAll('.btn-editar');
        const btnsEliminar = document.querySelectorAll('.btn-eliminar');
        const btnsCerrar = document.querySelectorAll('.btn-cerrar');
        const btnsCancelar = document.querySelectorAll('.btn-cancelar');

        function abrirModalEditar(id, nombre) {
          document.getElementById('editId').value = id;
          document.getElementById('editNombre').value = nombre;
          modalEditar.classList.add('active');
        }

        function abrirModalEliminar(id, nombre) {
          document.getElementById('eliminarId').value = id;
          document.getElementById('nombreCategoria').textContent = nombre;
          modalEliminar.classList.add('active');
        }

        function cerrarModales() {
          modalEditar.classList.remove('active');
          modalEliminar.classList.remove('active');
        }

        btnsEditar.forEach(btn => {
          btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const nombre = this.getAttribute('data-nombre');
            abrirModalEditar(id, nombre);
          });
        });

        btnsEliminar.forEach(btn => {
          btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const nombre = this.getAttribute('data-nombre');
            abrirModalEliminar(id, nombre);
          });
        });

        btnsCerrar.forEach(btn => {
          btn.addEventListener('click', cerrarModales);
        });

        btnsCancelar.forEach(btn => {
          btn.addEventListener('click', cerrarModales);
        });

        modalEditar.addEventListener('click', function(e) {
          if (e.target === modalEditar) {
            cerrarModales();
          }
        });

        modalEliminar.addEventListener('click', function(e) {
          if (e.target === modalEliminar) {
            cerrarModales();
          }
        });

        formEditar.addEventListener('submit', async function(e) {
          e.preventDefault();
          const id     = document.getElementById('editId').value;
          const nombre = document.getElementById('editNombre').value;

          try {
            const res = await fetch(`/categorias/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ nombre })
            });
            
            const resData = await res.json();
            if (!resData.status) throw new Error(resData.data);

            document.querySelector(`button[data-id="${id}"]`)
                    .closest('tr')
                    .querySelector('td:nth-child(2)')
                    .textContent = nombre;

            alert(resData.data.message);
            cerrarModales();
          } catch (err) {
            console.error(err);
            alert('Error al actualizar: ' + err.message);
          }
        });

        formEliminar.addEventListener('submit', async function(e) {
          e.preventDefault();
          const id = document.getElementById('eliminarId').value;

          try {
            const res = await fetch(`/categorias/${id}`, {
              method: 'DELETE'
            });

            const resData = await res.json();
            if (!resData.status) throw new Error(resData.data);

            document.querySelector(`button[data-id="${id}"]`)
                    .closest('tr')
                    .remove();

            alert(resData.data.message);
            cerrarModales();
          } catch (err) {
            console.error(err);
            alert('Error al eliminar: ' + err.message);
          }
        });

      });
    </script>
  </body>
</html>
